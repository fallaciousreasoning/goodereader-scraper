<!doctype html>
<html>

<head>
    <title>eReaders</title>
    <meta name="description" content="A page for comparing various ereaders">
    <style>
        body {
            display: flex;
            flex-direction: row;
            gap: 8px;
            background-color: #EEEEEE;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            padding: 8px;
        }

        .filter-set {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            white-space: nowrap;
        }

        #filters {
            width: 300px;
            flex-shrink: 0;
        }

        #readersContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 8px;
            flex: 1;
        }

    </style>
</head>

<body>
    <div id="filters" class="card">
        <h2>Filters</h2>
        <hr />
    </div>
    <div id="readersContainer">

    </div>

    <script type="text/javascript">
        const readersContainer = document.getElementById('readersContainer');
        const filters = document.getElementById('filters');

        const getFilters = () => {
            const filters = {};
            const checkboxes = Array.from(document.querySelectorAll('input[type="checkbox"]'));
            for (const checkbox of checkboxes) {
                const property = checkbox.dataset.property;
                const value = checkbox.dataset.value;

                if (!checkbox.checked) continue;

                if (!filters[property]) filters[property] = new Set();
                filters[property].add(value);
            }
            return filters
        }

        const isHidden = (filters, reader) => {
            for (const key of Object.keys(filters)) {
                if (!(key in reader)) return true;

                const filter = filters[key];
                const value = reader[key];

                if (filter instanceof Set) {
                    if (!filter.has(value))
                    return true;
                }
            }

            return false;
        }

        const createReader = (reader) => {
            const excludedKeys = new Set(['title', 'url']);
            const container = document.createElement('div');

            const infoKeys = Object.keys(reader)
                .filter(k => !excludedKeys.has(k))
            container.innerHTML = `<div class="card">
                <a href="${reader.url}" target="_blank" rel="noopener">${reader.title}</a>
                <hr/>
                <details>
                    <summary><b>Specs</b></summary>
                    ${infoKeys.map(k => `<div>
                        <b>${k}: </b> ${reader[k]}
                    </div>`).join('\n')}
                </details>
            </div>`

            readersContainer.appendChild(container);
            
            const listener = (e) => container.style = isHidden(getFilters(), reader) ? 'display: none' : undefined;
            for (const input of Array.from(document.querySelectorAll('input')))
                input.addEventListener('change', listener);
        }

        const createOptionFilter = (property, readers) => {
            const options = new Set();
            for (const reader of readers) {
                if (!reader[property]) continue
                options.add(reader[property]);
            }

            const optionsEl = document.createElement('div');
            optionsEl.innerHTML = `
            <details class='filter-set'>
                <summary>
                    <b>${property}</b>
                </summary>
                ${Array.from(options).map(o => `<label>
                    <input data-property="${property}" data-value="${o}" type='checkbox' />
                    ${o}
                </label>`).join('\n')}
            </details>
            `
            filters.appendChild(optionsEl);
        }

        const createTemplates = async () => {
            const data = await fetch('products.json').then(r => r.json());
            createOptionFilter('Display', data);
            createOptionFilter('Waterproof', data);
            createOptionFilter('Data Connector', data);
            createOptionFilter('Front Light', data);
            createOptionFilter('Color Temperature', data);
            createOptionFilter('Bluetooth', data);
            createOptionFilter('WIFI', data);
            createOptionFilter('Micro SD', data);
            createOptionFilter('Digital Pen', data);
            createOptionFilter('Physical Page Turn Buttons', data);
            createOptionFilter('Operating System', data);

            for (const reader of data)
                createReader(reader);
        }
        createTemplates()
    </script>
</body>

</html>
